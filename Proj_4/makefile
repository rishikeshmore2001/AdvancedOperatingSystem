# Makefile for CIS 620 Project 4 with RPC and CUDA

CC = gcc
NVCC = nvcc
CFLAGS = -g -Wall -Wno-unused-variable -I/usr/include/tirpc
NVCCFLAGS = -arch=sm_60 -Xcompiler -fPIC -Wno-deprecated-gpu-targets
LDFLAGS = -L/lib/x86_64-linux-gnu -ltirpc -lm

# Files generated by rpcgen
XDR = ldshr_xdr.c
CLNT = ldshr_clnt.c
SVC = ldshr_svc.c
HDR = ldshr.h

# Targets
all: ldshr ldshr_svc

# RPC generation
ldshr.h ldshr_clnt.c ldshr_svc.c ldshr_xdr.c: ldshr.x
	rpcgen ldshr.x

# CUDA object
getmax.o: getmax.cu
	$(NVCC) $(NVCCFLAGS) -c getmax.cu -o getmax.o

# Client compilation
ldshr.o: ldshr.c $(HDR)
	$(CC) $(CFLAGS) -c ldshr.c

ldshr_clnt.o: $(CLNT)
	$(CC) $(CFLAGS) -c $(CLNT)

ldshr_xdr.o: $(XDR)
	$(CC) $(CFLAGS) -c $(XDR)

# Server compilation
ldshr_svc.o: $(SVC)
	$(CC) $(CFLAGS) -c $(SVC)

ldshr_svc_proc.o: ldshr_svc_proc.c $(HDR)
	$(CC) $(CFLAGS) -c ldshr_svc_proc.c

# Client executable
ldshr: ldshr.o ldshr_clnt.o ldshr_xdr.o
	$(CC) $(CFLAGS) -o ldshr ldshr.o ldshr_clnt.o ldshr_xdr.o -ltirpc

# Server executable (uses nvcc for CUDA linking)
ldshr_svc: ldshr_svc.o ldshr_svc_proc.o ldshr_xdr.o getmax.o
	$(NVCC) -o ldshr_svc ldshr_svc.o ldshr_svc_proc.o ldshr_xdr.o getmax.o -ltirpc -lm

# Cleanup
clean:
	rm -f *.o ldshr ldshr_svc $(CLNT) $(SVC) $(XDR) $(HDR)
